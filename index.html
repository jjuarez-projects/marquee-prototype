<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Marquee Manager Prototype</title>
<style>
  body { font-family: sans-serif; }
  section { margin-bottom: 2em; }
  ul { list-style-type: none; padding-left: 0; }
  li { margin-bottom: 0.5em; }
  input[type="text"], input[type="date"] { width: 200px; }
  li[draggable="true"] {
  cursor: grab;
  padding: 4px;
  border: 1px solid #ccc;
  margin: 2px 0;
  background: #f9f9f9;
}

li[draggable="true"]:active {
  cursor: grabbing;
  background: #e0e0e0;
}
</style>
</head>
<body>
  <h1>School Marquee Manager Prototype</h1>

  <!-- Draft Creation -->
  <section>
    <h2>Create Message Draft</h2>
    <form method="POST" action="insert_message.php">
      <label>Message:</label>
      <input type="text" name="content" required><br>

      <label>Select lines:</label><br>
      <input type="checkbox" name="lines[]" value="1"> Line 1
      <input type="checkbox" name="lines[]" value="2"> Line 2
      <input type="checkbox" name="lines[]" value="3"> Line 3
      <input type="checkbox" name="lines[]" value="4"> Line 4
      <br><br>
      <button type="submit">Submit Message</button>
    </form>
  </section>

  <!-- Lists -->
  <section>
    <h2>Drafts</h2>
    <ul id="draftList"></ul>
  </section>

  <section>
    <h2>Pending Approvals</h2>
    <ul id="pendingList"></ul>
  </section>

  <section>
    <h2>Approved / Scheduled</h2>
    <ul id="approvedList"></ul>
  </section>

  <section>
    <h2>Prep Sheet (Todayâ€™s Work)</h2>
    <ul id="prepSheetList">
        <?php
$prepSheet = $mysqli->query("
    SELECT ps.prepsheet_id, ml.line_id, m.content
    FROM PrepSheet ps
    JOIN MessageLines ml ON ps.message_line_id = ml.message_line_id
    JOIN Messages m ON ml.message_id = m.message_id
    ORDER BY ps.position ASC
");

while($row = $prepSheet->fetch_assoc()){
    echo '<li draggable="true" data-id="'.$row['prepsheet_id'].'">';
    echo 'Line '.$row['line_id'].': '.$row['content'];
    echo '</li>';
}
?>
      </ul>
  </section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // In-memory data store (prototype)
  let messages = [];
  let nextId = 1;

  // Helpers
  function todayStr() {
    const d = new Date();
    return d.toISOString().split('T')[0];
  }

  function clearLists() {
    document.getElementById("draftList").innerHTML = "";
    document.getElementById("pendingList").innerHTML = "";
    document.getElementById("approvedList").innerHTML = "";
    document.getElementById("prepSheet").innerHTML = "";
  }

  // Render everything
  function render() {
    clearLists();
    const draftList = document.getElementById("draftList");
    const pendingList = document.getElementById("pendingList");
    const approvedList = document.getElementById("approvedList");
    const prepSheet = document.getElementById("prepSheet");
    const today = todayStr();

    messages.forEach(msg => {
      const content = msg.lines.filter(l => l).join(" | ") || "(blank)";

      // DRAFT
      if (msg.status === "draft") {
        const li = document.createElement("li");
        li.textContent = content + " ";
        const submitBtn = document.createElement("button");
        submitBtn.textContent = "Submit for Approval";
        submitBtn.onclick = () => { msg.status = "pending"; render(); };

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.style.marginLeft = "6px";
        delBtn.onclick = () => { messages = messages.filter(m => m.id !== msg.id); render(); };

        li.appendChild(submitBtn);
        li.appendChild(delBtn);
        draftList.appendChild(li);
      }

      // PENDING
      if (msg.status === "pending") {
        const li = document.createElement("li");
        li.textContent = content + " [Pending] ";

        const startInput = document.createElement("input");
        startInput.type = "date";
        startInput.value = msg.startDate || today;

        const endInput = document.createElement("input");
        endInput.type = "date";
        endInput.value = msg.endDate || today;

        const approveBtn = document.createElement("button");
        approveBtn.textContent = "Approve";
        approveBtn.onclick = () => {
          if (!startInput.value || !endInput.value) {
            alert("Please select start and end dates before approving.");
            return;
          }
          msg.startDate = startInput.value;
          msg.endDate = endInput.value;
          msg.status = "approved";
          render();
        };

        const rejectBtn = document.createElement("button");
        rejectBtn.textContent = "Reject";
        rejectBtn.style.marginLeft = "6px";
        rejectBtn.onclick = () => { msg.status = "draft"; render(); };

        li.appendChild(document.createTextNode(" Start: "));
        li.appendChild(startInput);
        li.appendChild(document.createTextNode(" End: "));
        li.appendChild(endInput);
        li.appendChild(approveBtn);
        li.appendChild(rejectBtn);
        pendingList.appendChild(li);
      }

      // APPROVED
      if (msg.status === "approved") {
        const outerLi = document.createElement("li");
        outerLi.style.marginBottom = "0.5rem";

        // Line list (draggable items)
        const lineList = document.createElement("ul");
        lineList.style.listStyle = "none";
        lineList.style.padding = "0";
        lineList.style.margin = "0 0 6px 0";
        lineList.style.maxWidth = "420px";

        msg.lines.forEach((lineText, idx) => {
          const lineLi = document.createElement("li");
          lineLi.textContent = lineText || "(blank)";
          lineLi.style.border = "1px solid #ccc";
          lineLi.style.padding = "6px";
          lineLi.style.margin = "4px 0";
          lineLi.style.background = "#f9f9f9";
          lineLi.style.cursor = "grab";
          lineLi.draggable = true;
          lineLi.dataset.msgId = msg.id;
          lineLi.dataset.index = idx;

          // Drag start
          lineLi.addEventListener('dragstart', (e) => {
            const payload = JSON.stringify({ msgId: msg.id, from: idx });
            e.dataTransfer.setData('application/json', payload);
            e.dataTransfer.effectAllowed = 'move';
            lineLi.style.opacity = '0.5';
          });

          lineLi.addEventListener('dragend', () => {
            lineLi.style.opacity = '1';
          });

          // Allow drop on each line (swap with target)
          lineLi.addEventListener('dragover', (e) => {
            e.preventDefault();
          });

          lineLi.addEventListener('drop', (e) => {
            e.preventDefault();
            try {
              const data = JSON.parse(e.dataTransfer.getData('application/json'));
              const fromMsgId = data.msgId;
              const fromIdx = data.from;
              const toIdx = parseInt(lineLi.dataset.index, 10);
              // Only allow reordering within the same message
              if (fromMsgId === msg.id) {
                const tmp = msg.lines[fromIdx];
                msg.lines[fromIdx] = msg.lines[toIdx];
                msg.lines[toIdx] = tmp;
                render();
              }
            } catch (err) {
              // ignore bad drop
            }
          });

          lineList.appendChild(lineLi);
        });

        // Allow dropping onto the list area to move to end
        lineList.addEventListener('dragover', (e) => { e.preventDefault(); });
        lineList.addEventListener('drop', (e) => {
          e.preventDefault();
          try {
            const data = JSON.parse(e.dataTransfer.getData('application/json'));
            if (data.msgId === msg.id) {
              const fromIdx = data.from;
              const val = msg.lines.splice(fromIdx, 1)[0];
              msg.lines.push(val);
              render();
            }
          } catch (err) { /* ignore */ }
        });

        outerLi.appendChild(lineList);

        // Date editors for approved message
        const dateRow = document.createElement('div');
        dateRow.style.marginTop = '6px';

        const startInput = document.createElement("input");
        startInput.type = "date";
        startInput.value = msg.startDate;

        const endInput = document.createElement("input");
        endInput.type = "date";
        endInput.value = msg.endDate;

        const updateBtn = document.createElement("button");
        updateBtn.textContent = "Update Dates";
        updateBtn.style.marginLeft = "6px";
        updateBtn.onclick = () => {
          msg.startDate = startInput.value;
          msg.endDate = endInput.value;
          render();
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.style.marginLeft = "6px";
        deleteBtn.style.background = "#cc0000";
        deleteBtn.onclick = () => {
          messages = messages.filter(m => m.id !== msg.id);
          render();
        };

        dateRow.appendChild(document.createTextNode("Start: "));
        dateRow.appendChild(startInput);
        dateRow.appendChild(document.createTextNode(" End: "));
        dateRow.appendChild(endInput);
        dateRow.appendChild(updateBtn);
        dateRow.appendChild(deleteBtn);

        outerLi.appendChild(dateRow);
        approvedList.appendChild(outerLi);

        // Prep sheet entry (only once per approved message)
        // Show if active today or starting/ending today
        if ((today >= msg.startDate && today <= msg.endDate) ||
            today === msg.startDate || today === msg.endDate) {

          const prepLi = document.createElement("li");
          prepLi.textContent = msg.lines.filter(l => l).join(" | ") +
                               ` (Active: ${msg.startDate} â€“ ${msg.endDate})`;

          if (msg.startDate === today) {
            prepLi.style.backgroundColor = "#d4edda";
            prepLi.style.fontWeight = "bold";
            prepLi.textContent += " â†’ ADD";
          } else if (msg.endDate === today) {
            prepLi.style.backgroundColor = "#f8d7da";
            prepLi.style.fontWeight = "bold";
            prepLi.textContent += " â†’ REMOVE";
          } else {
            prepLi.style.backgroundColor = "#fff3cd"; // active
          }

          prepSheet.appendChild(prepLi);
        }
      }
    });
  }

  // Create message (status: draft or pending)
  function createMessage(status) {
    const lines = [
      document.getElementById("line1").value.trim(),
      document.getElementById("line2").value.trim(),
      document.getElementById("line3").value.trim(),
      document.getElementById("line4").value.trim()
    ];
    messages.push({
      id: nextId++,
      lines,
      status,
      startDate: null,
      endDate: null
    });
    // clear inputs
    document.getElementById("line1").value = "";
    document.getElementById("line2").value = "";
    document.getElementById("line3").value = "";
    document.getElementById("line4").value = "";
    render();
  }

  // Wire up buttons
  document.getElementById("saveDraftBtn").addEventListener("click", () => createMessage("draft"));
  document.getElementById("submitPendingBtn").addEventListener("click", () => createMessage("pending"));

  // initial render
  render();
});

  const list = document.getElementById('prepSheetList');
  let dragged = null;

  list.addEventListener('dragstart', e => dragged = e.target);
  list.addEventListener('dragover', e => e.preventDefault());
  list.addEventListener('drop', e => {
    e.preventDefault();
    if(e.target.tagName === 'LI'){
      list.insertBefore(dragged, e.target.nextSibling);
      // Optional: AJAX to update position in PrepSheet table
    }
  });
</script>

</body>
</html>
